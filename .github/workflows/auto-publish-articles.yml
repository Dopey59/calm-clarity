name: 📝 Publication Intelligente 3x/Semaine

on:
  schedule:
    # LUNDI matin - 3 horaires possibles (7h-10h Paris)
    - cron: '0 5 * * 1'    # 7h Paris
    - cron: '30 6 * * 1'   # 8h30 Paris
    - cron: '0 8 * * 1'    # 10h Paris
    
    # MERCREDI après-midi - 3 horaires possibles (17h-20h Paris)
    - cron: '0 15 * * 3'   # 17h Paris
    - cron: '30 16 * * 3'  # 18h30 Paris
    - cron: '0 18 * * 3'   # 20h Paris
    
    # VENDREDI matin - 3 horaires possibles (7h-10h Paris)
    - cron: '0 5 * * 5'    # 7h Paris
    - cron: '30 7 * * 5'   # 9h30 Paris
    - cron: '0 8 * * 5'    # 10h Paris
    
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-intelligent:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 📦 Install dependencies
        run: npm ci
      
      # ÉTAPE CRITIQUE : Sélection intelligente du keyword
      - name: 🎯 Sélection intelligente keyword
        id: select
        run: |
          node << 'EOFSCRIPT'
          const fs = require('fs');
          
          // Charger keywords.json
          const keywords = JSON.parse(fs.readFileSync('keywords.json', 'utf8'));
          
          // Combiner tous les articles (piliers + satellites)
          const allArticles = [
            ...keywords.stress.piliers,
            ...keywords.stress.satellites,
            ...keywords.anxiete.piliers,
            ...keywords.anxiete.satellites
          ];
          
          // Filtrer uniquement les "todo"
          const available = allArticles.filter(a => a.status === 'todo');
          
          console.log(`📊 Articles disponibles : ${available.length}/90`);
          
          if (available.length === 0) {
            console.log('❌ Plus de keywords disponibles !');
            console.log('✅ LES 90 ARTICLES SONT PUBLIÉS ! 🎉');
            process.exit(0);
          }
          
          // Sélection ALÉATOIRE
          const randomIndex = Math.floor(Math.random() * available.length);
          const selected = available[randomIndex];
          
          console.log(`\n🎲 Keyword sélectionné : "${selected.keyword}"`);
          console.log(`   Type : ${selected.type}`);
          console.log(`   Catégorie : ${selected.id.startsWith('stress') ? 'stress' : 'anxiete'}`);
          console.log(`   Longueur : ${selected.wordCount} mots`);
          
          // Extraire les infos
          const category = selected.id.startsWith('stress') ? 'stress' : 'anxiete';
          const topic = selected.keyword;
          const type = selected.type;
          const wordCount = selected.wordCount;
          const pilierParent = selected.pilierParent || '';
          const selectedId = selected.id;
          
          // Créer les outputs
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `category=${category}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `topic=${topic}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `type=${type}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `wordCount=${wordCount}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `pilierParent=${pilierParent}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `selectedId=${selectedId}\n`);
          
          // Marquer comme "done"
          const updateKeywords = (data, id) => {
            ['stress', 'anxiete'].forEach(cat => {
              ['piliers', 'satellites'].forEach(arr => {
                const idx = data[cat][arr].findIndex(a => a.id === id);
                if (idx !== -1) {
                  data[cat][arr][idx].status = 'done';
                  data[cat][arr][idx].publishedAt = new Date().toISOString();
                  console.log(`✅ Marqué comme "done" : ${id}`);
                }
              });
            });
            return data;
          };
          
          const updated = updateKeywords(keywords, selected.id);
          fs.writeFileSync('keywords.json', JSON.stringify(updated, null, 2));
          console.log(`\n📝 keywords.json mis à jour`);
          EOFSCRIPT
      
      # Générer l'article
      - name: 🤖 Générer article
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CATEGORY: ${{ steps.select.outputs.category }}
          TOPIC: ${{ steps.select.outputs.topic }}
          ARTICLE_TYPE: ${{ steps.select.outputs.type }}
          WORD_COUNT: ${{ steps.select.outputs.wordCount }}
          PILIER_PARENT: ${{ steps.select.outputs.pilierParent }}
        run: npm run generate-article
      
      # Build pour générer le sitemap
      - name: 🏗️ Build projet (génère sitemap)
        run: npm run build
      
      # Commit
      - name: 💾 Commit article + keywords.json + sitemap
        run: |
          git config user.name "Bot CalmeClair"
          git config user.email "bot@calmeclair.com"
          git add src/content/articles/
          git add keywords.json
          git add dist/sitemap.xml 2>/dev/null || echo "Sitemap non trouvé dans dist/"
          
          if git diff --staged --quiet; then
            echo "Aucun changement à commiter"
          else
            git commit -m "📝 [${{ steps.select.outputs.type }}] ${{ steps.select.outputs.topic }}"
            git push
            echo "✅ Article publié avec succès !"
          fi
      
      # 🆕 SOUMISSION AUTOMATIQUE SITEMAP
      - name: 📤 Soumettre sitemap à Google
        env:
          GOOGLE_SEARCH_CONSOLE_CREDENTIALS: ${{ secrets.GOOGLE_SEARCH_CONSOLE_CREDENTIALS }}
        run: |
          if [ -z "$GOOGLE_SEARCH_CONSOLE_CREDENTIALS" ]; then
            echo "⚠️ GOOGLE_SEARCH_CONSOLE_CREDENTIALS non configuré"
            echo "ℹ️ Le sitemap ne sera pas soumis automatiquement"
            echo "📚 Configuration : GitHub Settings > Secrets > GOOGLE_SEARCH_CONSOLE_CREDENTIALS"
          else
            echo "📤 Soumission du sitemap à Google Search Console..."
            npm run submit-sitemap || echo "⚠️ Erreur soumission sitemap (article publié quand même)"
          fi
      
      # Ping Google manuellement (fallback si credentials manquants)
      - name: 🔔 Ping Google (fallback)
        if: env.GOOGLE_SEARCH_CONSOLE_CREDENTIALS == ''
        run: |
          echo "📡 Ping Google pour indexation rapide..."
          curl -s "https://www.google.com/ping?sitemap=https://calmeclair.com/sitemap.xml" || echo "Ping envoyé"