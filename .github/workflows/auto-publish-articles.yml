name: üìù Publication Intelligente 3x/Semaine

on:
  schedule:
    # LUNDI matin - 3 horaires possibles (7h-10h Paris)
    - cron: '0 5 * * 1'    # 7h Paris
    - cron: '30 6 * * 1'   # 8h30 Paris
    - cron: '0 8 * * 1'    # 10h Paris
    
    # MERCREDI apr√®s-midi - 3 horaires possibles (17h-20h Paris)
    - cron: '0 15 * * 3'   # 17h Paris
    - cron: '30 16 * * 3'  # 18h30 Paris
    - cron: '0 18 * * 3'   # 20h Paris
    
    # VENDREDI matin - 3 horaires possibles (7h-10h Paris)
    - cron: '0 5 * * 5'    # 7h Paris
    - cron: '30 7 * * 5'   # 9h30 Paris
    - cron: '0 8 * * 5'    # 10h Paris
    
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-intelligent:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      # √âTAPE CRITIQUE : S√©lection intelligente du keyword
      - name: üéØ S√©lection intelligente keyword
        id: select
        run: |
          node << 'EOFSCRIPT'
          const fs = require('fs');
          
          // Charger keywords.json
          const keywords = JSON.parse(fs.readFileSync('keywords.json', 'utf8'));
          
          // Combiner tous les articles (piliers + satellites)
          const allArticles = [
            ...keywords.stress.piliers,
            ...keywords.stress.satellites,
            ...keywords.anxiete.piliers,
            ...keywords.anxiete.satellites
          ];
          
          // Filtrer uniquement les "todo"
          const available = allArticles.filter(a => a.status === 'todo');
          
          console.log(`üìä Articles disponibles : ${available.length}/90`);
          
          if (available.length === 0) {
            console.log('‚ùå Plus de keywords disponibles !');
            console.log('‚úÖ LES 90 ARTICLES SONT PUBLI√âS ! üéâ');
            process.exit(0); // Exit proprement (pas d'erreur)
          }
          
          // S√©lection AL√âATOIRE
          const randomIndex = Math.floor(Math.random() * available.length);
          const selected = available[randomIndex];
          
          console.log(`\nüé≤ Keyword s√©lectionn√© : "${selected.keyword}"`);
          console.log(`   Type : ${selected.type}`);
          console.log(`   Cat√©gorie : ${selected.id.startsWith('stress') ? 'stress' : 'anxiete'}`);
          console.log(`   Longueur : ${selected.wordCount} mots`);
          
          // Extraire les infos
          const category = selected.id.startsWith('stress') ? 'stress' : 'anxiete';
          const topic = selected.keyword;
          const type = selected.type;
          const wordCount = selected.wordCount;
          const pilierParent = selected.pilierParent || '';
          const selectedId = selected.id;
          
          // Cr√©er les outputs pour GitHub Actions
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `category=${category}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `topic=${topic}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `type=${type}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `wordCount=${wordCount}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `pilierParent=${pilierParent}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `selectedId=${selectedId}\n`);
          
          // Fonction pour marquer comme "done"
          const updateKeywords = (data, id) => {
            ['stress', 'anxiete'].forEach(cat => {
              ['piliers', 'satellites'].forEach(arr => {
                const idx = data[cat][arr].findIndex(a => a.id === id);
                if (idx !== -1) {
                  data[cat][arr][idx].status = 'done';
                  data[cat][arr][idx].publishedAt = new Date().toISOString();
                  console.log(`‚úÖ Marqu√© comme "done" : ${id}`);
                }
              });
            });
            return data;
          };
          
          // Mettre √† jour keywords.json
          const updated = updateKeywords(keywords, selected.id);
          fs.writeFileSync('keywords.json', JSON.stringify(updated, null, 2));
          
          console.log(`\nüìù keywords.json mis √† jour`);
          EOFSCRIPT
      
      # G√©n√©rer l'article avec les param√®tres extraits
      - name: ü§ñ G√©n√©rer article
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CATEGORY: ${{ steps.select.outputs.category }}
          TOPIC: ${{ steps.select.outputs.topic }}
          ARTICLE_TYPE: ${{ steps.select.outputs.type }}
          WORD_COUNT: ${{ steps.select.outputs.wordCount }}
          PILIER_PARENT: ${{ steps.select.outputs.pilierParent }}
        run: npm run generate-article
      
      # Commit des changements
      - name: üíæ Commit article + keywords.json
        run: |
          git config user.name "Bot CalmeClair"
          git config user.email "bot@calmeclair.com"
          git add src/content/articles/
          git add keywords.json
          
          # V√©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "Aucun changement √† commiter"
          else
            git commit -m "üìù [${{ steps.select.outputs.type }}] ${{ steps.select.outputs.topic }}"
            git push
            echo "‚úÖ Article publi√© avec succ√®s !"
          fi
