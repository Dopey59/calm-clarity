name: Auto-g√©n√©rer et publier articles MDX

on:
  schedule:
    # 9h Paris (7h UTC) - Article STRESS
    - cron: '0 7 * * *'
    # 15h Paris (13h UTC) - Article ANXI√âT√â  
    - cron: '0 13 * * *'
  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-and-publish-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: D√©terminer la cat√©gorie selon l'heure
        id: category
        run: |
          HOUR=$(date -u +%H)
          echo "Heure UTC actuelle: $HOUR"
          
          if [ "$HOUR" -ge 6 ] && [ "$HOUR" -lt 10 ]; then
            echo "category=stress" >> $GITHUB_OUTPUT
            echo "topic=stress" >> $GITHUB_OUTPUT
            echo "üìä Cat√©gorie s√©lectionn√©e: STRESS (matin)"
          else
            echo "category=anxiete" >> $GITHUB_OUTPUT
            echo "topic=anxi√©t√©" >> $GITHUB_OUTPUT
            echo "üò∞ Cat√©gorie s√©lectionn√©e: ANXI√âT√â (apr√®s-midi)"
          fi
      
      - name: G√©n√©rer l'article MDX
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          CATEGORY: ${{ steps.category.outputs.category }}
          TOPIC: ${{ steps.category.outputs.topic }}
        run: npm run generate-article
      
      - name: R√©g√©n√©rer l'index
        run: npm run build-index
      
      - name: Commit et push
        env:
          CATEGORY: ${{ steps.category.outputs.category }}
          TOPIC: ${{ steps.category.outputs.topic }}
        run: |
          git config user.name "CalmeClair Bot"
          git config user.email "bot@calmeclair.com"
          
          git add public/_index.json
          git add content/articles/$CATEGORY/*.mdx
          git add content/_index.json
          
          if git diff --staged --quiet; then
            echo "Aucun nouvel article g√©n√©r√©"
            exit 0
          fi
          
          ARTICLE_NAME=$(ls -t content/articles/$CATEGORY/*.mdx | head -1 | xargs basename -s .mdx)
          
          git commit -m "ü§ñ Nouvel article MDX - $TOPIC - $ARTICLE_NAME"
          git push
      
      - name: Submit sitemap to Google Search Console
        env:
          GOOGLE_SEARCH_CONSOLE_CREDENTIALS: ${{ secrets.GOOGLE_SEARCH_CONSOLE_CREDENTIALS }}
        run: npm run submit-sitemap
        continue-on-error: true
      
      - name: Summary
        run: |
          echo "‚úÖ Article MDX publi√© avec succ√®s!"
          echo "üìÅ Cat√©gorie: ${{ steps.category.outputs.topic }}"
          echo "üñºÔ∏è  Image optimis√©e incluse"
          echo "üìä Index JSON r√©g√©n√©r√©"
          echo "üí∞ Article optimis√© pour Google AdSense"
          echo "üó∫Ô∏è  Sitemap soumis √† Google Search Console"
          echo "üì¢ Vercel va d√©ployer automatiquement"
