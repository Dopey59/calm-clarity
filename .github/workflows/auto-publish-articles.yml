name: üìù Publication Intelligente 3x/Semaine

on:
  schedule:
    # LUNDI matin 7h-10h - AL√âATOIRE via multiple triggers
    - cron: '0 5 * * 1'     # 7h00 Paris
    - cron: '12 5 * * 1'    # 7h12 Paris
    - cron: '23 5 * * 1'    # 7h23 Paris
    - cron: '37 5 * * 1'    # 7h37 Paris
    - cron: '46 5 * * 1'    # 7h46 Paris
    - cron: '1 6 * * 1'     # 8h01 Paris
    - cron: '14 6 * * 1'    # 8h14 Paris
    - cron: '28 6 * * 1'    # 8h28 Paris
    - cron: '39 6 * * 1'    # 8h39 Paris
    - cron: '52 6 * * 1'    # 8h52 Paris
    - cron: '4 7 * * 1'     # 9h04 Paris
    - cron: '17 7 * * 1'    # 9h17 Paris
    - cron: '31 7 * * 1'    # 9h31 Paris
    - cron: '43 7 * * 1'    # 9h43 Paris
    - cron: '56 7 * * 1'    # 9h56 Paris
    
    # MERCREDI apr√®s-midi 17h-20h - AL√âATOIRE
    - cron: '8 15 * * 3'    # 17h08 Paris
    - cron: '19 15 * * 3'   # 17h19 Paris
    - cron: '27 15 * * 3'   # 17h27 Paris
    - cron: '34 15 * * 3'   # 17h34 Paris
    - cron: '48 15 * * 3'   # 17h48 Paris
    - cron: '2 16 * * 3'    # 18h02 Paris
    - cron: '15 16 * * 3'   # 18h15 Paris
    - cron: '26 16 * * 3'   # 18h26 Paris
    - cron: '41 16 * * 3'   # 18h41 Paris
    - cron: '53 16 * * 3'   # 18h53 Paris
    - cron: '7 17 * * 3'    # 19h07 Paris
    - cron: '21 17 * * 3'   # 19h21 Paris
    - cron: '38 17 * * 3'   # 19h38 Paris
    - cron: '49 17 * * 3'   # 19h49 Paris
    - cron: '58 17 * * 3'   # 19h58 Paris
    
    # VENDREDI matin 7h-10h - AL√âATOIRE
    - cron: '6 5 * * 5'     # 7h06 Paris
    - cron: '18 5 * * 5'    # 7h18 Paris
    - cron: '29 5 * * 5'    # 7h29 Paris
    - cron: '43 5 * * 5'    # 7h43 Paris
    - cron: '54 5 * * 5'    # 7h54 Paris
    - cron: '9 6 * * 5'     # 8h09 Paris
    - cron: '22 6 * * 5'    # 8h22 Paris
    - cron: '36 6 * * 5'    # 8h36 Paris
    - cron: '47 6 * * 5'    # 8h47 Paris
    - cron: '59 6 * * 5'    # 8h59 Paris
    - cron: '11 7 * * 5'    # 9h11 Paris
    - cron: '24 7 * * 5'    # 9h24 Paris
    - cron: '35 7 * * 5'    # 9h35 Paris
    - cron: '48 7 * * 5'    # 9h48 Paris
    - cron: '57 7 * * 5'    # 9h57 Paris
    
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      # üÜï V√âRIFICATION : D√©j√† publi√© aujourd'hui ?
      - name: üîç V√©rifier publications du jour
        id: check
        run: |
          node << 'EOFSCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          // Charger keywords.json
          const keywords = JSON.parse(fs.readFileSync('keywords.json', 'utf8'));
          
          // Date aujourd'hui
          const today = new Date().toISOString().split('T')[0];
          console.log(`Verification pour: ${today}`);
          
          // Compter articles publi√©s aujourd'hui
          const allArticles = [
            ...keywords.stress.piliers,
            ...keywords.stress.satellites,
            ...keywords.anxiete.piliers,
            ...keywords.anxiete.satellites
          ];
          
          const todayPublished = allArticles.filter(a => 
            a.status === 'done' && 
            a.publishedAt && 
            a.publishedAt.startsWith(today)
          );
          
          console.log(`Articles publies aujourd hui: ${todayPublished.length}`);
          
          // LIMITE : 1 article par jour maximum
          if (todayPublished.length >= 1) {
            console.log('Article deja publie aujourd hui');
            console.log('Annulation du workflow (limite 1/jour)');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_skip=true\n');
          } else {
            console.log('Aucun article publie aujourd hui');
            console.log('Lancement de la generation');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'should_skip=false\n');
          }
          EOFSCRIPT
      
      # S√©lection intelligente keyword
      - name: üéØ S√©lection intelligente keyword
        if: steps.check.outputs.should_skip == 'false'
        id: select
        run: |
          node << 'EOFSCRIPT'
          const fs = require('fs');
          
          const keywords = JSON.parse(fs.readFileSync('keywords.json', 'utf8'));
          
          const allArticles = [
            ...keywords.stress.piliers,
            ...keywords.stress.satellites,
            ...keywords.anxiete.piliers,
            ...keywords.anxiete.satellites
          ];
          
          const available = allArticles.filter(a => a.status === 'todo');
          
          console.log(`Articles disponibles: ${available.length}/90`);
          
          if (available.length === 0) {
            console.log('LES 90 ARTICLES SONT PUBLIES !');
            process.exit(0);
          }
          
          const randomIndex = Math.floor(Math.random() * available.length);
          const selected = available[randomIndex];
          
          console.log(`\nKeyword selectionne: "${selected.keyword}"`);
          console.log(`   Type: ${selected.type}`);
          console.log(`   Categorie: ${selected.id.startsWith('stress') ? 'stress' : 'anxiete'}`);
          console.log(`   Longueur: ${selected.wordCount} mots`);
          
          const category = selected.id.startsWith('stress') ? 'stress' : 'anxiete';
          const topic = selected.keyword;
          const type = selected.type;
          const wordCount = selected.wordCount;
          const pilierParent = selected.pilierParent || '';
          const selectedId = selected.id;
          
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `category=${category}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `topic=${topic}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `type=${type}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `wordCount=${wordCount}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `pilierParent=${pilierParent}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `selectedId=${selectedId}\n`);
          
          const updateKeywords = (data, id) => {
            ['stress', 'anxiete'].forEach(cat => {
              ['piliers', 'satellites'].forEach(arr => {
                const idx = data[cat][arr].findIndex(a => a.id === id);
                if (idx !== -1) {
                  data[cat][arr][idx].status = 'done';
                  data[cat][arr][idx].publishedAt = new Date().toISOString();
                  console.log(`Marque comme done: ${id}`);
                }
              });
            });
            return data;
          };
          
          const updated = updateKeywords(keywords, selected.id);
          fs.writeFileSync('keywords.json', JSON.stringify(updated, null, 2));
          
          console.log(`\nkeywords.json mis a jour`);
          EOFSCRIPT
      
      # G√©n√©rer l'article
      - name: ü§ñ G√©n√©rer article
        if: steps.check.outputs.should_skip == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CATEGORY: ${{ steps.select.outputs.category }}
          TOPIC: ${{ steps.select.outputs.topic }}
          ARTICLE_TYPE: ${{ steps.select.outputs.type }}
          WORD_COUNT: ${{ steps.select.outputs.wordCount }}
          PILIER_PARENT: ${{ steps.select.outputs.pilierParent }}
        run: npm run generate-article
      
      # Build pour g√©n√©rer sitemap
      - name: üèóÔ∏è Build projet (g√©n√®re sitemap)
        if: steps.check.outputs.should_skip == 'false'
        run: npm run build
      
      # Commit
      - name: üíæ Commit article + keywords.json + sitemap
        if: steps.check.outputs.should_skip == 'false'
        run: |
          git config user.name "Bot CalmeClair"
          git config user.email "bot@calmeclair.com"
          git add src/content/articles/
          git add keywords.json
          git add dist/sitemap.xml 2>/dev/null || echo "Sitemap non trouve"
          
          if git diff --staged --quiet; then
            echo "Aucun changement a commiter"
          else
            git commit -m "üìù [${{ steps.select.outputs.type }}] ${{ steps.select.outputs.topic }}"
            git push
            echo "Article publie avec succes"
          fi
      
      # Soumission sitemap
      - name: üì§ Soumettre sitemap √† Google
        if: steps.check.outputs.should_skip == 'false'
        env:
          GOOGLE_SEARCH_CONSOLE_CREDENTIALS: ${{ secrets.GOOGLE_SEARCH_CONSOLE_CREDENTIALS }}
        run: |
          if [ -z "$GOOGLE_SEARCH_CONSOLE_CREDENTIALS" ]; then
            echo "Credentials non configures"
            echo "Ping Google..."
            curl -s "https://www.google.com/ping?sitemap=https://calmeclair.com/sitemap.xml" || echo "Ping envoye"
          else
            echo "Soumission API Google..."
            npm run submit-sitemap || echo "Erreur soumission"
          fi
