name: üîÑ Migration automatique vers MDX

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Installer gray-matter
        run: npm install gray-matter
      
      - name: Migration vers MDX
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          // Lire le fichier articles.ts
          const articlesContent = fs.readFileSync('src/data/articles.ts', 'utf8');
          
          // Extraire le tableau d'articles (regex simplifi√©e)
          const articlesMatch = articlesContent.match(/export const articles[^=]*=\s*\[([\s\S]*)\];/);
          
          if (!articlesMatch) {
            console.log('‚ùå Impossible de trouver les articles');
            process.exit(1);
          }
          
          // Parser les articles (approche simplifi√©e pour 13 articles)
          const articlesText = articlesMatch[1];
          
          // Cr√©er les dossiers
          ['content/articles/anxiete', 'content/articles/stress'].forEach(dir => {
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }
          });
          
          // Split par les s√©parateurs d'objets
          const articleBlocks = articlesText.split(/},\s*{/);
          
          const articles = [];
          
          articleBlocks.forEach((block, index) => {
            // Nettoyer le bloc
            block = block.trim();
            if (!block.startsWith('{')) block = '{' + block;
            if (!block.endsWith('}')) block = block + '}';
            
            // Extraire les champs
            const extract = (field) => {
              const match = block.match(new RegExp(`${field}:\\s*['"\`](.*?)['"\`]`, 's'));
              return match ? match[1].replace(/\\n/g, '\n').replace(/\\'/g, "'") : '';
            };
            
            const extractArray = (field) => {
              const match = block.match(new RegExp(`${field}:\\s*\\[(.*?)\\]`, 's'));
              if (!match) return [];
              return match[1].split(',').map(t => t.trim().replace(/['"]/g, '')).filter(Boolean);
            };
            
            const extractNumber = (field) => {
              const match = block.match(new RegExp(`${field}:\\s*(\\d+)`));
              return match ? parseInt(match[1]) : 0;
            };
            
            const extractBoolean = (field) => {
              const match = block.match(new RegExp(`${field}:\\s*(true|false)`));
              return match ? match[1] === 'true' : false;
            };
            
            const extractContent = () => {
              const match = block.match(/content:\s*`([\s\S]*?)`\s*,/);
              return match ? match[1] : '';
            };
            
            const article = {
              id: extract('id'),
              slug: extract('slug'),
              title: extract('title'),
              excerpt: extract('excerpt'),
              content: extractContent(),
              category: extract('category'),
              categoryLabel: extract('categoryLabel'),
              tags: extractArray('tags'),
              image: extract('image'),
              imageAlt: extract('imageAlt'),
              datePublished: extract('datePublished'),
              dateModified: extract('dateModified'),
              readingTime: extractNumber('readingTime'),
              featured: extractBoolean('featured'),
            };
            
            if (article.id && article.slug) {
              articles.push(article);
              
              // Cr√©er le fichier MDX
              const frontmatter = `---
id: "${article.id}"
slug: "${article.slug}"
title: "${article.title.replace(/"/g, '\\"')}"
excerpt: "${article.excerpt.replace(/"/g, '\\"')}"
category: "${article.category}"
categoryLabel: "${article.categoryLabel}"
tags: [${article.tags.map(t => `"${t}"`).join(', ')}]
image: "${article.image}"
imageAlt: "${article.imageAlt}"
datePublished: "${article.datePublished}"
dateModified: "${article.dateModified}"
readingTime: ${article.readingTime}
featured: ${article.featured}
---

${article.content}
`;
              
              const filename = `${article.slug}.mdx`;
              const filepath = path.join('content/articles', article.category, filename);
              
              fs.writeFileSync(filepath, frontmatter, 'utf8');
              console.log(`‚úÖ ${article.category}/${filename}`);
            }
          });
          
          // G√©n√©rer l'index
          const index = articles.map(a => ({
            id: a.id,
            slug: a.slug,
            title: a.title,
            excerpt: a.excerpt,
            category: a.category,
            categoryLabel: a.categoryLabel,
            tags: a.tags,
            image: a.image,
            imageAlt: a.imageAlt,
            datePublished: a.datePublished,
            dateModified: a.dateModified,
            readingTime: a.readingTime,
            featured: a.featured,
          }));
          
          fs.writeFileSync('content/_index.json', JSON.stringify(index, null, 2), 'utf8');
          
          console.log(`\nüéâ Migration termin√©e: ${articles.length} articles`);
          SCRIPT
      
      - name: Commit et Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add content/
          git commit -m "‚ú® Migration compl√®te vers MDX

- 13 articles migr√©s vers fichiers individuels
- Index JSON g√©n√©r√©
- Structure optimis√©e pour scalabilit√©"
          
          git push
