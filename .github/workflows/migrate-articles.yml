name: üîÑ Migration automatique vers MDX

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Cr√©er le script de migration
        run: |
          cat > migrate.js << 'ENDOFFILE'
          const fs = require('fs');
          const path = require('path');
          
          console.log('üöÄ D√©marrage migration...\n');
          
          // Lire le fichier articles.ts
          const articlesContent = fs.readFileSync('src/data/articles.ts', 'utf8');
          
          // Extraire le tableau d'articles
          const articlesMatch = articlesContent.match(/export const articles[^=]*=\s*\[([\s\S]*)\];/);
          
          if (!articlesMatch) {
            console.log('‚ùå Impossible de trouver les articles');
            process.exit(1);
          }
          
          const articlesText = articlesMatch[1];
          
          // Cr√©er les dossiers
          ['content/articles/anxiete', 'content/articles/stress'].forEach(dir => {
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }
          });
          
          // Split par les s√©parateurs d'objets
          const articleBlocks = articlesText.split(/},\s*{/);
          
          const articles = [];
          
          articleBlocks.forEach((block, index) => {
            block = block.trim();
            if (!block.startsWith('{')) block = '{' + block;
            if (!block.endsWith('}')) block = block + '}';
            
            const extract = (field) => {
              const regex = new RegExp(field + ':\\s*[\'"`]([\\s\\S]*?)[\'"`]', 's');
              const match = block.match(regex);
              if (!match) return '';
              return match[1].replace(/\\n/g, '\n').replace(/\\'/g, "'");
            };
            
            const extractArray = (field) => {
              const regex = new RegExp(field + ':\\s*\\[([^\\]]+)\\]');
              const match = block.match(regex);
              if (!match) return [];
              return match[1].split(',').map(t => t.trim().replace(/['"]/g, '')).filter(Boolean);
            };
            
            const extractNumber = (field) => {
              const regex = new RegExp(field + ':\\s*(\\d+)');
              const match = block.match(regex);
              return match ? parseInt(match[1]) : 0;
            };
            
            const extractBoolean = (field) => {
              const regex = new RegExp(field + ':\\s*(true|false)');
              const match = block.match(regex);
              return match ? match[1] === 'true' : false;
            };
            
            const extractContent = () => {
              const match = block.match(/content:\s*`([\s\S]*?)`[,\s]*(?:datePublished|$)/);
              return match ? match[1] : '';
            };
            
            const article = {
              id: extract('id'),
              slug: extract('slug'),
              title: extract('title'),
              excerpt: extract('excerpt'),
              content: extractContent(),
              category: extract('category'),
              categoryLabel: extract('categoryLabel'),
              tags: extractArray('tags'),
              image: extract('image'),
              imageAlt: extract('imageAlt'),
              datePublished: extract('datePublished'),
              dateModified: extract('dateModified'),
              readingTime: extractNumber('readingTime'),
              featured: extractBoolean('featured'),
            };
            
            if (article.id && article.slug) {
              articles.push(article);
              
              const titleClean = article.title.replace(/"/g, '\\"');
              const excerptClean = article.excerpt.replace(/"/g, '\\"');
              
              const frontmatter = '---\n' +
                'id: "' + article.id + '"\n' +
                'slug: "' + article.slug + '"\n' +
                'title: "' + titleClean + '"\n' +
                'excerpt: "' + excerptClean + '"\n' +
                'category: "' + article.category + '"\n' +
                'categoryLabel: "' + article.categoryLabel + '"\n' +
                'tags: [' + article.tags.map(t => '"' + t + '"').join(', ') + ']\n' +
                'image: "' + article.image + '"\n' +
                'imageAlt: "' + article.imageAlt + '"\n' +
                'datePublished: "' + article.datePublished + '"\n' +
                'dateModified: "' + article.dateModified + '"\n' +
                'readingTime: ' + article.readingTime + '\n' +
                'featured: ' + article.featured + '\n' +
                '---\n\n' +
                article.content + '\n';
              
              const filename = article.slug + '.mdx';
              const filepath = path.join('content/articles', article.category, filename);
              
              fs.writeFileSync(filepath, frontmatter, 'utf8');
              console.log('‚úÖ ' + article.category + '/' + filename);
            }
          });
          
          // G√©n√©rer l'index
          const index = articles.map(a => ({
            id: a.id,
            slug: a.slug,
            title: a.title,
            excerpt: a.excerpt,
            category: a.category,
            categoryLabel: a.categoryLabel,
            tags: a.tags,
            image: a.image,
            imageAlt: a.imageAlt,
            datePublished: a.datePublished,
            dateModified: a.dateModified,
            readingTime: a.readingTime,
            featured: a.featured,
          }));
          
          fs.writeFileSync('content/_index.json', JSON.stringify(index, null, 2), 'utf8');
          
          console.log('\nüéâ Migration termin√©e: ' + articles.length + ' articles migr√©s!');
          ENDOFFILE
      
      - name: Ex√©cuter la migration
        run: node migrate.js
      
      - name: V√©rifier les fichiers cr√©√©s
        run: |
          echo "üìÅ Fichiers cr√©√©s:"
          ls -la content/articles/anxiete/
          ls -la content/articles/stress/
          echo ""
          echo "üìä Index:"
          cat content/_index.json | head -20
      
      - name: Commit et Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add content/
          git commit -m "‚ú® Migration compl√®te vers MDX

- Articles migr√©s vers fichiers individuels
- Index JSON g√©n√©r√©
- Structure optimis√©e pour scalabilit√©"
          
          git push
